<!DOCTYPE html>
<!--
vim:ts=4:sw=4:tw=0:wm=0:et
-->
<html>

<head>
    <meta charset="utf-8"></meta>
    <!-- jQuery Mobile CDN -->
    <!-- Include meta tag to ensure proper rendering and touch zooming -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Include jQuery Mobile stylesheets -->
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">

    <!-- Include the jQuery library -->
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>

    <script>
        // Bind to "mobileinit" before you load jquery.mobile.js
        $(document).on("mobileinit", function() {
            $.mobile.listview.prototype.options.autodividersSelector = function(elt) {
                var text = $.trim(elt.text()) || null;
                if (!text) {
                    return null;
                }
                if (!isNaN(parseFloat(text))) {
                    var value = Math.floor(parseFloat(text) / 100);
                    return ">> UserSort: " + value + "00 to " + value + "99";
                } else {
                    text = text.slice(0, 1).toUpperCase();
                    return text;
                }
            };
        });
    </script>

    <!-- Include the jQuery Mobile library -->
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

    <style>
        .gc {
            color: red;
            font-weight: bold
        }

        table {
            background-color: lightyellow;
            width: 80%;
        }

        table,
        th,
        td {
            border: solid 1px black;
            text-align: center
        }

        // th {background-color: yellow}
        thead {
            background-color: lightblue
        }
    </style>
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.12/css/jquery.dataTables.min.css"></script>
    <script src="latlon.js"></script>
    <script src="topo853a - Effingham IL.gpx.js"></script>
    <script>
        var fillCachePopup = function(cache) {

            console.log(cache);

            var table = $("<table/>").attr("alt", "Popup table");
            table.append($("<caption/>").text(cache.name));

            var row;
            row = $("<tr/>");
            row.append($("<th/>").text("key"));
            row.append($("<th/>").text("value"));

            table.append(row);
            Object.keys(cache).forEach(function(ele, index) {
                row = $("<tr/>");
                var td1 = $("<td/>").text(ele.replace("groundspeak:", ""));
                var td2 = $("<td/>").text(cache[ele]);
                if (
                    (ele === "groundspeak:short_description") ||
                    (ele === "groundspeak:long_description")
                ){
                    var desc = cache[ele];
                    if (desc["@html"] === "True") {
                        td2.text("").html(desc["#text"]);
                    } else {
                        td2.text(desc["#text"]);
                    }
                    console.log(cache[ele])
                    row.append(td1).append(td2);
                } else {
                    row.append(td1).append(td2);
                }
                table.append(row);
            });
            // this anchor is required to make the Close button work
            var anchor = $("<a/>")
                .attr("href", "#")
                .attr("data-rel", "back")
                .addClass("ui-btn ui-corner-all ui-shadow ui-btn ui-icon-delete ui-btn-icon-notext ui-btn-right")
                .text("Close");
            $("#cachePopup").html(anchor);
            $("#cachePopup").append(table);
        };

        var fillGsakPopup = function(cache) {

            console.log(cache);

            var table = $("<table/>").attr("alt", "Popup table");
            table.append($("<caption/>").text(cache.name));

            var row;
            row = $("<tr/>");
            row.append($("<th/>").text("gsak: key"));
            row.append($("<th/>").text("value"));

            table.append(row);
            Object.keys(cache).forEach(function(ele, index) {
                row = $("<tr/>");
                var td1 = $("<td/>").text(ele.replace("gsak:", ""));
                var td2 = $("<td/>").text(cache[ele]);
                row.append(td1).append(td2);
                table.append(row);
            });
            // this anchor is required to make the Close button work
            var anchor = $("<a/>")
                .attr("href", "#")
                .attr("data-rel", "back")
                .addClass("ui-btn ui-corner-all ui-shadow ui-btn ui-icon-delete ui-btn-icon-notext ui-btn-right")
                .text("Close");
            $("#gsakPopup").html(anchor);
            $("#gsakPopup").append(table);
        };
    </script>
</head>

<body>

    <div data-role="popup" id="cachePopup" class="ui-content">
        <a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a> Popup goes here!
    </div>

    <div data-role="popup" id="gsakPopup" class="ui-content">
        <a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a> Popup goes here!
    </div>

    <table>
        <thead id="thead">
        </thead>
        <tbody id="tbody">
        </tbody>
    </table>
    <script>
        var wpts = data.gpx.wpt;

        var hkeys = [];
        var tr = $("<tr/>");
        Object.keys(wpts[0]).forEach(function(key, index) {
            if (key === "link") {
                return false;
            }
            hkeys.push(key);
            var th = $("<th/>").text(key);
            tr.append(th);
        })
        $("#thead").append(tr);

        $(wpts).each(function(index, wpt) {
            var tr = $("<tr/>");
            var link = wpt["link"];
            var hasLink = link["@href"] !== "";
            hkeys.forEach(function(key) {
                var td = $("<td/>");
                if (key == "@lat") {
                    td.text(latstr(wpt[key]));
                } else if (key === "@lon") {
                    td.text(lonstr(wpt[key]));
                } else if (key === "name") {
                    td.text(wpt[key]);
                    if (hasLink) {
                        td.addClass("gc");
                    }
                } else if (key === "type") {
                    td.text(wpt[key].replace("Geocache|", ""));
                } else if (key === "desc") {
                    if (link["@href"] !== "") {
                        var a = $("<a/>")
                            .text(wpt[key])
                            .attr("href", link["@href"])
                            .attr("target", "_blank");
                        td.html(a);
                    } else {
                        td.html(wpt[key])
                    }
                } else if (key === "extensions") {
                    var name = wpt.name;
                    var span = $("<span/>");
                    var $table = $("<table>");
                    var a1 = $("<a/>")
                        .attr("href", "#cachePopup")
                        .attr("data-rel", "popup")
                        .addClass("ui-btn ui-btn-inline ui-corner-all")
                        .html("Cache: " + name);
                    var a2 = $("<a/>")
                        .attr("href", "#gsakPopup")
                        .attr("data-rel", "popup")
                        .addClass("ui-btn ui-btn-inline ui-corner-all")
                        .html("GSAK:" + name);
                    var $td1 = $("<td/>").append(a1);
                    var $td2 = $("<td/>").append(a2);
                    var $row = $("<tr/>").append($td1).append($td2);
                    $table.append($row);
                    span.append($table);
                    a1.on("click", function(event) {
                        // console.log(wpt.extensions);
                        fillCachePopup(wpt.extensions["groundspeak:cache"]);
                    });
                    a2.on("click", function(event) {
                        // console.log(wpt.extensions["gsak:wptExtension"]);
                        fillGsakPopup(wpt.extensions["gsak:wptExtension"]);
                    });
                    td.html(span);
                } else {
                    td.text(wpt[key]);
                }
                tr.append(td);
            });
            $("#tbody").append(tr);
        });
    </script>
</body>

</html>
